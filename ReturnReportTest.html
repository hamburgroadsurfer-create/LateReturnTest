<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <title>Fleet Monitor ‚Äì Return & Security</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöê</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b0f14;
      --surface: rgba(255, 255, 255, 0.06);
      --surface2: rgba(255, 255, 255, 0.09);
      --border: rgba(255, 255, 255, 0.14);
      --text: rgba(255, 255, 255, 0.92);
      --muted: rgba(255, 255, 255, 0.68);
      --brand: #0b6efd;
      --ok: #198754;
      --warn: #ffc107;
      --bad: #dc3545;
      --unk: #6c757d;
      --radius: 14px;
      --sans: system-ui, -apple-system, sans-serif;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fb;
        --surface: #ffffff;
        --surface2: #f2f5fb;
        --border: rgba(0, 0, 0, 0.10);
        --text: rgba(0, 0, 0, 0.88);
        --muted: rgba(0, 0, 0, 0.62);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      padding-bottom: 60px;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo {
      font-weight: 900;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo span {
      background: linear-gradient(135deg, var(--brand), #1b8cff);
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .card-h {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      font-weight: bold;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.02);
    }

    .card-b {
      padding: 20px;
    }

    /* Mode Switcher */
    .mode-switch {
      background: rgba(11, 110, 253, 0.1);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .mode-label {
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    .mode-label input {
      width: 1.2em;
      height: 1.2em;
    }

    /* Drop Zones */
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .drop {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.02);
      transition: 0.2s;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .drop.dragover {
      background: rgba(11, 110, 253, 0.1);
      border-color: var(--brand);
    }

    .drop-l {
      font-weight: bold;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }

    .filemeta {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 5px;
    }

    input[type=file] {
      width: 100%;
    }

    /* Controls */
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 15px;
      align-items: end;
      flex-wrap: wrap;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .field label {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--muted);
    }

    .field input,
    .field select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
    }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
      transition: 0.1s;
    }

    button.primary {
      background: var(--brand);
      color: white;
      border-color: transparent;
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.1);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Summary & Table */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .sum-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .sum-val {
      font-size: 1.8rem;
      font-weight: 900;
      margin: 5px 0;
    }

    .sum-lbl {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .tablewrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
      font-size: 0.9rem;
    }

    th {
      text-align: left;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      backdrop-filter: blur(5px);
    }

    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Status Badges */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: white;
      display: inline-block;
    }

    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
      vertical-align: middle;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }

    .bg-green {
      background: var(--ok);
    }

    .bg-yellow {
      background: var(--warn);
      color: black;
    }

    .bg-red {
      background: var(--bad);
    }

    .bg-grey {
      background: var(--unk);
    }

    .mono {
      font-family: monospace;
    }

    .spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid #888;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Helper for disabled section */
    .disabled-area {
      opacity: 0.4;
      pointer-events: none;
      filter: grayscale(1);
    }

    .wave-btn {
      text-decoration: none;
      font-size: 1.5rem;
      transition: transform 0.2s;
      display: inline-block;
    }

    .wave-btn:hover {
      transform: scale(1.2) rotate(-10deg);
    }

    .mode-label {
      padding: 10px 15px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .mode-label:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    input[type="radio"]:checked+span {
      text-decoration: underline;
      text-underline-offset: 4px;
      color: var(--brand);
    }
  </style>
  <script src="report_data.js"></script>
</head>

<body>

  <div class="wrap">
    <div class="topbar">
      <div class="logo"><span>FM</span> Fleet Monitor</div>
      <div>
        <!-- Templates removed -->
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        Daten & Konfiguration
      </div>

      <div class="mode-switch">
        <label class="mode-label">
          <input type="radio" name="appMode" value="return" checked onchange="toggleMode()">
          <span>üöó Return Check (Customer)</span>
        </label>
        <label class="mode-label">
          <input type="radio" name="appMode" value="security" onchange="toggleMode()">
          <span>üëÆ Security / Night Check (Theft)</span>
        </label>
        <label class="mode-label" style="opacity:0.5; cursor:not-allowed;" title="Coming Soon">
          <input type="radio" name="appMode" value="unified" onchange="toggleMode()" disabled>
          <span>üöÄ Unified Check (Locked)</span>
        </label>
      </div>

      <div class="card-b">
        <div class="row">
          <div class="drop" data-drop="booking">
            <div class="drop-l">
              <span id="labelInput1">üìå Vehicle List (Returns Today)</span>
              <span class="badge bg-green" id="badgeInput1">Return Logic</span>
            </div>
            <input id="bookingFile" type="file" accept=".csv,.xlsx">
            <div class="filemeta" id="bookingMeta">No file selected</div>
          </div>

          <div class="drop" data-drop="stations">
            <div class="drop-l">
              <span>üèÅ Stations Master</span>
              <span class="badge bg-grey">Cache</span>
            </div>
            <input id="stationFile" type="file" accept=".csv,.xlsx">
            <div class="filemeta" id="stationMeta">No file selected</div>
          </div>

          <div class="drop" data-drop="gnss">
            <div class="drop-l">
              <span>üõ∞Ô∏è TCU / PowerBI Export</span>
              <span class="badge bg-grey">Cache</span>
            </div>
            <input id="gnssFile" type="file" accept=".csv,.xlsx">
            <div class="filemeta" id="gnssMeta">No file selected</div>
          </div>
        </div>

        <div class="controls">
          <div class="field" id="thresholdControls">
            <label>Gr√ºn Radius (km)</label>
            <input type="number" id="greenInput" value="200">
          </div>
          <div class="field" id="thresholdControls2">
            <label>Gelb Radius (km)</label>
            <input type="number" id="yellowInput" value="1000">
          </div>
          <div class="field disabled-area" id="secInputWrapper">
            <label>Security Radius (km)</label>
            <input type="number" id="secInput" value="15">
          </div>

          <div style="flex-grow:1"></div>

          <div class="spinner" id="spinner"></div>
          <button id="generateBtn" class="primary" onclick="generateReport()">Calculate Status</button>
          <button id="exportBtn" disabled onclick="exportCsv()">CSV Export</button>
        </div>
        <div id="errorBox" style="color:var(--bad); margin-top:10px; font-weight:bold;"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <span>Analysis</span>
        <select id="filterStatus" onchange="renderTable()" style="font-size:0.9rem; padding:4px;">
          <option value="all">All Status</option>
          <option value="red">Only RED (Alarm)</option>
          <option value="yellow">Only YELLOW</option>
          <option value="green">Only GREEN</option>
        </select>
        <select id="sortMode" onchange="renderTable()" style="font-size:0.9rem; padding:4px; margin-left:10px;">
          <option value="status">Sort: Status (Red top)</option>
          <option value="dist_desc">Sort: Distance (Far -> Near)</option>
          <option value="dist_asc">Sort: Distance (Near -> Far)</option>
        </select>
      </div>
      <div class="card-b">
        <div id="summary" class="summary-grid"></div>
        <div id="tableHost"></div>
      </div>
    </div>
  </div>

  <script>
    /* --- KONFIGURATION & STATE --- */
    let lastData = [];
    let stationCache = null;
    let gnssCache = null;

    // UI Elemente
    const ui = {
      modeRadios: document.getElementsByName('appMode'),
      label1: document.getElementById('labelInput1'),
      badge1: document.getElementById('badgeInput1'),
      thresh1: document.getElementById('thresholdControls'),
      thresh2: document.getElementById('thresholdControls2'),
      btn: document.getElementById('generateBtn'),
      inputs: {
        booking: document.getElementById('bookingFile'),
        stations: document.getElementById('stationFile'),
        gnss: document.getElementById('gnssFile')
      },
      metas: {
        booking: document.getElementById('bookingMeta'),
        stations: document.getElementById('stationMeta'),
        gnss: document.getElementById('gnssMeta')
      },
      err: document.getElementById('errorBox')
    };

    // Check LocalStorage f√ºr Stations
    // Check LocalStorage
    try {
      const cachedStations = localStorage.getItem('fm_stations_v1');
      if (cachedStations) {
        stationCache = JSON.parse(cachedStations);
        ui.metas.stations.innerText = "üíæ Stations from Cache (" + stationCache.length + ")";
      }
      const cachedGnss = localStorage.getItem('fm_gnss_v1');
      if (cachedGnss) {
        gnssCache = JSON.parse(cachedGnss);
        ui.metas.gnss.innerText = "üíæ GNSS from Cache (" + gnssCache.length + ")";
      }
    } catch (e) { console.warn("Cache Error", e); }

    /* --- LOGIK: MODUS UMSCHALTEN --- */
    function toggleMode() {
      const mode = document.querySelector('input[name="appMode"]:checked').value;

      // Swap Auto Files if available
      if (typeof autoFiles !== 'undefined') {
        const targetFile = (mode === 'security') ? autoFiles.security : autoFiles.return;
        if (targetFile) {
          const dt = new DataTransfer();
          dt.items.add(targetFile);
          ui.inputs.booking.files = dt.files;
          ui.inputs.booking.dispatchEvent(new Event('change'));
        }
      }

      if (mode === 'security') {
        ui.label1.innerHTML = "üìå <strong>Vehicle List</strong> <br><small>(Cars without Booking / Away from Station)</small>";
        ui.badge1.innerText = "Security Check";
        ui.badge1.className = "badge bg-yellow";
        ui.btn.innerText = "üõ°Ô∏è Start Security Check";

        // Configs
        ui.thresh1.classList.add('disabled-area');
        ui.thresh2.classList.add('disabled-area');
        document.getElementById('secInputWrapper').classList.remove('disabled-area');

        // Show/Hide inputs
        document.querySelector('[data-drop="gnss"]').style.display = 'block';
        document.querySelector('[data-drop="booking"]').style.display = 'block';

      } else if (mode === 'unified') {
        // UNIFIED MODE
        ui.label1.innerHTML = "üìå <strong>Unified Fleet Export</strong> <br><small>(Combined Bookings & GPS)</small>";
        ui.badge1.innerText = "Unified";
        ui.badge1.className = "badge bg-blue"; // New color maybe?
        ui.btn.innerText = "üöÄ Run Unified Check";

        // Configs: Enable all?
        ui.thresh1.classList.remove('disabled-area');
        ui.thresh2.classList.remove('disabled-area');
        document.getElementById('secInputWrapper').classList.add('disabled-area');

        // Hide GNSS input as it is inside the unified file
        document.querySelector('[data-drop="gnss"]').style.display = 'none';
        document.querySelector('[data-drop="booking"]').style.display = 'block';

      } else {
        // RETURN MODE
        ui.label1.innerHTML = "üìå <strong>Vehicle List</strong> <br><small>(Returns Today)</small>";
        ui.badge1.innerText = "Return Logic";
        ui.badge1.className = "badge bg-green";
        ui.btn.innerText = "üö¶ Calculate Status";

        // Configs
        ui.thresh1.classList.remove('disabled-area');
        ui.thresh2.classList.remove('disabled-area');
        document.getElementById('secInputWrapper').classList.add('disabled-area');

        // Show inputs
        document.querySelector('[data-drop="gnss"]').style.display = 'block';
        document.querySelector('[data-drop="booking"]').style.display = 'block';
      }
    }

    /* --- CORE: BERECHNUNG --- */
    async function generateReport() {
      ui.err.innerText = '';
      const mode = document.querySelector('input[name="appMode"]:checked').value;
      setBusy(true);

      try {
        // 1. Dateien parsen
        const bookingRows = await getRows(ui.inputs.booking, 'Liste 1 (Vehicle List)');

        // GNSS Handling (File or Cache)
        let gnssRows = [];
        if (mode !== 'unified') {
          if (ui.inputs.gnss.files.length > 0) {
            gnssRows = await getRows(ui.inputs.gnss, 'GNSS Export');
            gnssCache = gnssRows;
            try { localStorage.setItem('fm_gnss_v1', JSON.stringify(gnssRows)); } catch (e) { console.warn("GNSS Cache full?"); }
          } else if (gnssCache) {
            gnssRows = gnssCache;
          } else {
            throw new Error("Bitte GNSS/TCU Liste hochladen.");
          }
        }

        // Station Handling (File or Cache)
        let stationRows = [];
        if (ui.inputs.stations.files.length > 0) {
          stationRows = await getRows(ui.inputs.stations, 'Stations');
          stationCache = stationRows;
          localStorage.setItem('fm_stations_v1', JSON.stringify(stationRows));
        } else if (stationCache) {
          stationRows = stationCache;
        } else {
          throw new Error("Bitte Stations-Liste hochladen.");
        }

        // 2. Maps bauen
        const stations = buildStationMap(stationRows);
        let gnss = new Map();

        if (mode === 'unified') {
          // UNIFIED MODE: Get GPS from Main List
          bookingRows.forEach(r => {
            const vin = findVal(r, ['vin', 'vehicle_id', 'fahrgestellnummer', 'tcu_data - vin']);
            const latStr = findVal(r, ['lat', 'gnss_lat', 'latitude', 'gps_latitude']);
            const lonStr = findVal(r, ['lon', 'gnss_lon', 'longitude', 'gps_longitude']);

            if (vin && latStr) {
              const lat = parseCoordinate(latStr);
              const lon = parseCoordinate(lonStr);
              const time = findVal(r, ['updated', 'time', 'timestamp', 'gps_timestamp', 'return_date']);
              if (!isNaN(lat)) gnss.set(vin, { lat, lon, time });
            }
          });
        } else {
          gnss = buildGnssMap(gnssRows);
        }
        const thresholds = {
          green: parseFloat(document.getElementById('greenInput').value) || 200,
          yellow: parseFloat(document.getElementById('yellowInput').value) || 1000,
          sec: parseFloat(document.getElementById('secInput').value) || 15
        };

        // AUTO-INJECT LOGIC: Check for window.reportData
        if (typeof window.reportData !== 'undefined') {
          // Check if we need to merge injected data with manually uploaded/cached
          // For now, if injected data exists, we prefer it or merge it?
          // Let's assume automation provides raw rows if possible, or we parse them here if they are passed as strings.
          // Actually, automation script will likely produce standard JSON objects if we do it right.
        }

        // 3. Haupt-Loop
        const result = bookingRows.map(row => {
          // Flexible Spaltennamen finden
          const vin = findVal(row, ['vin', 'vehicle_id', 'fahrgestellnummer']);
          const stationName = findVal(row, ['station', 'home_station', 'return_station', 'station_name']);

          // Zus√§tzliche Infos (je nach Modus)
          let infoText = "";
          let dateInfo = "";

          // Fix mileage parsing (Smart check for DE vs US)
          let milRaw = findVal(row, ['km', 'mileage', 'kilometerstand', 'km_stand']);
          let mileage = 0;
          if (milRaw) {
            let clean = milRaw.toString().trim();
            // Scenario 1: "11.957" (DE) -> 11957. Scenario 2: "83889.0" (US Float) -> 83889
            if (clean.match(/^\d+$/)) {
              mileage = parseFloat(clean);
            } else if (clean.match(/^\d+\.0+$/)) {
              mileage = parseFloat(clean); // "83889.0" -> 83889
            } else if (clean.includes('.') && !clean.includes(',')) {
              // Formatting like 11.957 (DE) or 11.9 (dist)
              // If it looks like thousands (3 digits after dot), assume DE
              // But if value would be tiny (<200) assuming US, and large (>1000) assuming DE, pick DE
              if (clean.match(/\.\d{3}$/) || clean.match(/\.\d{3}\./)) {
                mileage = parseFloat(clean.replace(/\./g, ''));
              } else {
                mileage = parseFloat(clean); // fallback
              }
            } else {
              // Maybe "10.000,50" -> remove dot, replace comma
              mileage = parseFloat(clean.replace(/\./g, '').replace(',', '.'));
            }
          }
          if (isNaN(mileage)) mileage = 0;

          // Common fields
          const eventType = findVal(row, ['event type', 'event_type']);
          const eventNote = findVal(row, ['event note', 'event_note', 'remark', 'grund', 'block_reason']);
          const eventEnd = findVal(row, ['event end date', 'event_end_date']);

          if (mode === 'security') {
            // Im Security Modus: Priorisiere Event Info, ignoriere generisches 'status'="IN_FLEET"
            const reason = findVal(row, ['block_reason', 'grund', 'remark']);
            // Wave Link auch im Security Modus anzeigen
            const url = findVal(row, ['url', 'wave_url', 'link', 'link to wave']);

            let parts = [];
            if (eventType) parts.push(`<strong>${eventType}</strong>`);
            if (eventNote) parts.push(`<span style="font-size:0.85em; color:var(--muted)">${eventNote}</span>`);
            if (eventEnd) parts.push(`<span style="font-size:0.8em">Bis: ${formatDate(eventEnd)}</span>`);
            if (url) parts.push(`<a href="${url}" target="_blank" class="wave-btn" title="Open in Wave">üåä</a>`);

            if (parts.length > 0) {
              infoText = parts.join('<br>');
            } else if (reason && reason !== 'IN_FLEET') {
              infoText = reason;
            } else {
              infoText = "‚Äì";
            }
          } else {
            // Im Return Modus nach Datum und Wave-Link
            const date = findVal(row, ['date', 'return_date', 'booking_return_date', 'event end date', 'event_end_date']);
            const url = findVal(row, ['url', 'wave_url', 'link', 'link to wave']);

            let extra = "";
            if (eventType) extra = `<br><small>${eventType}</small>`;

            infoText = url ? `<a href="${url}" target="_blank" class="wave-btn" title="Open in Wave">üåä</a>${extra}` : (eventType || "");
            dateInfo = date ? formatDate(date) : "";
          }

          // Station matchen
          const stationObj = matchStation(stationName, stations);

          // GNSS holen
          const carGps = gnss.get(vin);

          let dist = null;
          let status = 'unknown';
          let distLabel = '‚Äì';
          let debug = [];

          if (!vin) debug.push("Keine VIN");
          if (!stationObj) debug.push("Station unbekannt: " + stationName);
          if (!carGps) debug.push("Kein GPS Signal");

          // Distanz berechnen
          if (stationObj && carGps && carGps.lat && carGps.lon) {

            // Check for valid lat/lon (prevent 0,0 or near zero)
            if (Math.abs(carGps.lat) < 1 && Math.abs(carGps.lon) < 1) {
              debug.push("Invalid GPS (0,0)");
            } else {
              // Check Time (Night Filter: 20:00 - 07:00)
              const gpsDate = parseDateVal(carGps.time);
              let isNight = true;
              if (gpsDate) {
                const h = gpsDate.getHours();
                if (h >= 7 && h < 20) isNight = false;
              }

              dist = haversine(stationObj.lat, stationObj.lon, carGps.lat, carGps.lon);
              distLabel = dist.toFixed(1) + " km";

              // --- ENTSCHEIDUNGS-LOGIK ---
              if (mode === 'security') {
                // SECURITY MODE (Only strict 'security' mode uses night filter)
                if (gpsDate && !isNight) {
                  status = 'unknown'; // Ignoriere Tags√ºber
                  distLabel += " ‚òÄÔ∏è";
                  debug.push("Tags√ºber");
                } else {
                  if (dist <= thresholds.sec) {
                    status = 'green';
                  } else {
                    status = 'red';
                    distLabel = "‚ö†Ô∏è " + distLabel;
                  }
                }
              } else {
                // RETURN MODE & UNIFIED MODE: Alles nah ist gr√ºn
                if (dist <= thresholds.green) status = 'green';
                else if (dist <= thresholds.yellow) status = 'yellow';
                else status = 'red';
              }
            }
          }

          // Coord Label (Car Only)
          const coordLabel = carGps ? `${carGps.lat.toFixed(5)}, ${carGps.lon.toFixed(5)}` : '-';

          // Station Coords
          const stationCoords = stationObj ? `(${stationObj.lat.toFixed(3)}, ${stationObj.lon.toFixed(3)})` : '';

          return {
            vin,
            stationName,
            matchedStation: stationObj ? stationObj.name : '-',
            gpsTime: carGps ? formatDate(carGps.time) : '-',
            dist,
            distLabel,
            status,
            infoText,
            dateInfo,
            mileage,
            coordLabel,
            stationCoords,
            debug: debug.join(', ')
          };
        });

        lastData = result;
        renderTable();
        document.getElementById('exportBtn').disabled = false;

      } catch (e) {
        ui.err.innerText = "Fehler: " + e.message;
        console.error(e);
      } finally {
        setBusy(false);
      }
    }

    /* --- HELPER FUNCTIONS --- */

    function parseCoordinate(val) {
      if (!val) return NaN;
      let s = val.toString().replace(/[¬∞]/g, '').trim();
      // Match decimal numbers: 50.12421000, -115.16605000, etc.
      const match = s.match(/([-+]?\d+\.?\d*)/);
      if (!match) return NaN;
      let num = parseFloat(match[1].replace(',', '.'));
      if (/[SW]/i.test(s)) num = -Math.abs(num);
      return num;
    }

    function parseDateVal(val) {
      if (!val) return null;
      if (val instanceof Date) return val;
      // Handle numeric strings like "46057.123" by converting to number
      const num = Number(val);
      if (!isNaN(num) && num > 20000 && num < 60000) {
        return new Date((num - 25569) * 86400 * 1000);
      }
      const d = new Date(val);
      return isNaN(d) ? null : d;
    }

    function formatDate(val) {
      const d = parseDateVal(val);
      if (!d) return val || "";
      return d.toLocaleDateString("de-DE") + " " + d.toLocaleTimeString("de-DE", { hour: '2-digit', minute: '2-digit' });
    }



    // Sucht einen Wert in einem Objekt basierend auf mehreren m√∂glichen Spaltennamen
    function findVal(row, candidates) {
      const keys = Object.keys(row);
      for (let c of candidates) {
        const found = keys.find(k => k.toLowerCase().includes(c));
        if (found && row[found]) return row[found].toString().trim();
      }
      return "";
    }

    function matchStation(rawName, map) {
      if (!rawName) return null;
      const key = rawName.toLowerCase().trim();
      // 1. Exakter Match
      if (map.has(key)) return map.get(key);
      // 2. Slug Match (Sonderzeichen weg)
      const slug = key.replace(/[^a-z0-9]/g, '');
      for (let [k, v] of map) {
        if (k.replace(/[^a-z0-9]/g, '') === slug) return v;
      }
      return null;
    }

    function buildStationMap(rows) {
      const m = new Map();
      rows.forEach(r => {
        const name = findVal(r, ['station', 'name', 'city']);
        let lat = parseCoordinate(findVal(r, ['lat', 'breite', 'latitude']));
        let lon = parseCoordinate(findVal(r, ['lon', 'l√§nge', 'long', 'longitude']));
        let swapped = false;

        // HEURISTIC: Fix swapped headers in Stations_Merged.csv
        // If Lat is actually Lon (small, e.g. 10) and Lon is actually Lat (large, e.g. 50) relative to Europe
        // Or if Lat is > 90 (impossible, implies it's a US Longitude like -115)
        if (!isNaN(lat) && !isNaN(lon)) {
          if (Math.abs(lat) > 90 || (Math.abs(lat) < 30 && Math.abs(lon) > 30)) {
            const tmp = lat;
            lat = lon;
            lon = tmp;
            swapped = true;
          }
        }

        if (name && !isNaN(lat) && !isNaN(lon)) {
          m.set(name.toLowerCase(), { name, lat, lon, swapped });
        }
      });
      return m;
    }

    function buildGnssMap(rows) {
      const m = new Map();
      rows.forEach(r => {
        const vin = findVal(r, ['vin', 'vehicle']);
        const lat = parseCoordinate(findVal(r, ['lat', 'gnss_lat']));
        const lon = parseCoordinate(findVal(r, ['lon', 'gnss_lon']));
        const time = findVal(r, ['updated', 'time', 'timestamp']);
        if (vin) m.set(vin, { lat, lon, time });
      });
      return m;
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371; // Erdradius km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    /* --- DATEI HANDLING --- */
    async function getRows(input, label) {
      if (!input.files.length) return []; // Optional, au√üer es wird gepr√ºft
      const file = input.files[0];
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data);
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      if (!json.length) throw new Error(label + " ist leer oder nicht lesbar.");
      return json;
    }

    // Meta Anzeige bei Datei-Auswahl
    Object.values(ui.inputs).forEach(inp => {
      inp.addEventListener('change', (e) => {
        const span = e.target.nextElementSibling;
        if (e.target.files[0]) span.innerText = "üìÑ " + e.target.files[0].name;
      });
    });

    /* --- RENDERING --- */
    function renderTable() {
      const host = document.getElementById('tableHost');
      const summary = document.getElementById('summary');
      const filter = document.getElementById('filterStatus').value;

      if (!lastData.length) {
        host.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">Keine Daten berechnet.</div>';
        return;
      }

      // Filter
      const filtered = lastData.filter(d => filter === 'all' || d.status === filter);

      const sortMode = document.getElementById('sortMode').value;

      // Sortierung
      // Sortierung
      filtered.sort((a, b) => {
        if (sortMode === 'dist_desc') {
          return (b.dist || 0) - (a.dist || 0); // Far to Near
        }
        if (sortMode === 'dist_asc') {
          return (a.dist || 0) - (b.dist || 0); // Near to Far
        }
        // Default: Rot oben
        const score = { red: 0, yellow: 1, green: 2, unknown: 3 };
        return score[a.status] - score[b.status];
      });

      // Summary Cards
      const counts = { red: 0, yellow: 0, green: 0, unknown: 0 };
      lastData.forEach(d => counts[d.status] = (counts[d.status] || 0) + 1);

      summary.innerHTML = `
    <div class="sum-card" style="border-bottom:4px solid var(--bad)">
      <div class="sum-val">${counts.red}</div>
      <div class="sum-lbl">ALARM / ROT</div>
    </div>
    <div class="sum-card" style="border-bottom:4px solid var(--warn)">
      <div class="sum-val">${counts.yellow}</div>
      <div class="sum-lbl">GELB</div>
    </div>
    <div class="sum-card" style="border-bottom:4px solid var(--ok)">
      <div class="sum-val">${counts.green}</div>
      <div class="sum-lbl">OK / GR√úN</div>
    </div>
    <div class="sum-card">
      <div class="sum-val">${counts.unknown}</div>
      <div class="sum-lbl">Unbekannt</div>
    </div>
  `;

      // Table HTML
      let html = `<table><thead><tr>
    <th>Status</th>
    <th>VIN</th>
    <th>Return Station</th>
    <th>Distance</th>
    <th>Link</th>
    <th>Coordinates</th>
    <th>GPS Time</th>
    <th>Debug</th>
  </tr></thead><tbody>`;

      filtered.forEach(row => {
        let badgeClass = 'bg-grey';
        if (row.status === 'red') badgeClass = 'bg-red';
        if (row.status === 'yellow') badgeClass = 'bg-yellow';
        if (row.status === 'green') badgeClass = 'bg-green';

        let stationDisplay = row.stationName;
        if (row.matchedStation && row.matchedStation !== '-' && row.matchedStation.toLowerCase() !== row.stationName.toLowerCase()) {
          stationDisplay += ` <small style="color:var(--muted)">(${row.matchedStation})</small>`;
        }
        if (row.stationCoords) {
          stationDisplay += `<br><small style="color:var(--muted); font-size:0.75rem">${row.stationCoords}</small>`;
        }

        html += `<tr>
      <td><span class="status-dot ${badgeClass}" title="${row.status.toUpperCase()}"></span></td>
      <td class="mono">${row.vin}</td>
      <td>${stationDisplay}</td>
      <td style="font-weight:bold">${row.distLabel}</td>
      <td>${row.infoText}</td>
      <td class="mono" style="font-size:0.75rem">${row.coordLabel}</td>
      <td class="mono" style="font-size:0.8rem">${row.gpsTime}</td>
      <td style="font-size:0.75rem; color:var(--muted)">${row.debug}</td>
    </tr>`;
      });
      html += '</tbody></table>';
      host.innerHTML = `<div class="tablewrap">${html}</div>`;
    }

    function exportCsv() {
      if (!lastData.length) return;
      const header = ["VIN", "Soll_Station", "Matched_Station", "Distanz_km", "Status", "Info", "GPS_Time", "Debug"];
      const rows = lastData.map(r => [r.vin, r.stationName, r.matchedStation, r.dist ? r.dist.toFixed(3) : '', r.status, r.infoText.replace(/<[^>]*>/g, ''), r.gpsTime, r.debug]);

      const csvContent = [header.join(";")].concat(rows.map(e => e.join(";"))).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "fleet_report.csv");
      document.body.appendChild(link);
      link.click();
    }



    function setBusy(isBusy) {
      document.getElementById('spinner').style.display = isBusy ? 'inline-block' : 'none';
      ui.btn.disabled = isBusy;
    }

    /* --- AUTO LOAD LOGIC --- */
    function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
      return new Blob(byteArrays, { type: contentType });
    }

    // Store auto-loaded blobs to swap them on mode change
    let autoFiles = { return: null, security: null };

    window.addEventListener('DOMContentLoaded', () => {
      if (typeof window.reportData !== 'undefined') {
        console.log("ü§ñ Auto-loading data found.");

        const loadInput = (key, inputId, mime) => {
          if (window.reportData[key]) {
            try {
              const item = window.reportData[key];
              const blob = b64toBlob(item.data, mime);
              const file = new File([blob], item.name, { type: mime });

              const dt = new DataTransfer();
              dt.items.add(file);
              document.getElementById(inputId).files = dt.files;
              document.getElementById(inputId).dispatchEvent(new Event('change'));
              return file;
            } catch (e) { console.error("AutoLoad Error " + key, e); }
          }
          return null;
        };

        // Load Static
        loadInput('tcu', 'gnssFile', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        loadInput('stations', 'stationFile', 'text/csv');

        // Prepare Pre-loaded files for modes
        if (window.reportData['bookings']) {
          // Create file object but dont assign yet dependent on mode
          const item = window.reportData['bookings'];
          const blob = b64toBlob(item.data, 'text/csv');
          autoFiles.return = new File([blob], item.name, { type: 'text/csv' });
        }
        if (window.reportData['cars']) {
          const item = window.reportData['cars'];
          const blob = b64toBlob(item.data, 'text/csv');
          autoFiles.security = new File([blob], item.name, { type: 'text/csv' });
        }

        // Initial Load (Default Return)
        if (autoFiles.return) {
          const dt = new DataTransfer();
          dt.items.add(autoFiles.return);
          document.getElementById('bookingFile').files = dt.files;
          document.getElementById('bookingFile').dispatchEvent(new Event('change'));
        }

        // Auto Run?
        // setTimeout(generateReport, 500);
      }
    });

  </script>
</body>

</html>