# Fleet Monitor â€“ Technical Documentation

This tool automates the **Return Check** and **Security Check** for the Roadsurfer fleet.  
It combines **Booking/Vehicle Lists** with **GPS Data (TCU)** and **Station Coordinates** to calculate distances and identify misplaced vehicles.

---

## ðŸš€ Quick Start (Automation)

The easiest way to run the tool is via the PowerShell script `UpdateDataAndRun.ps1`.

### How it works

1. **Finds Data**: Searches `...\FleetData\Exports\TCU` for the **newest** Excel file (`TCU health...xlsx`).
2. **Loads Locals**: Reads `Stations_Merged.csv` and the relevant booking list (`Bookings_Return_Today.csv` or `Cars without Booking...csv`) from the current folder.
3. **Injects Logic**: Converts these files to Base64 and injects them into `ReturnReportTest.html`.
4. **Opens Browser**: Launches the report with all data pre-loaded.

---

## ðŸ›  Features & Logic

### 1. Coordinate Logic (The "China Fix")

The tool includes a robust parser (`parseCoordinate`) to handle various coordinate formats:

* **Decimal**: `48.123` / `-11.555`
* **Directional**: `115.089 W` -> `-115.089` (Fixes US locations showing up in China).
* **Swapped Columns**: In `Stations_Merged.csv`, the headers "Latitude" and "Longitude" are sometimes swapped. The tool detects this automatically:
  * *Heuristic*: If `Lat` < 30 (unlikely for EU/US stations) and `Lon` > 30, it effectively swaps them back.
  * *Result*: Stations like Nuremberg and WÃ¼rzburg appear in Germany, not Africa or the Ocean.

### 2. Distance Calculation

* Uses the **Haversine Formula** to calculate the distance between the **Station** coordinate and the **Vehicle** coordinate (TCU).
* **Radius Logic**:
  * **Return Mode**:
    * ðŸŸ¢ **Green**: Distance < 200km (Configurable)
    * ðŸŸ¡ **Yellow**: Distance < 1000km
    * ðŸ”´ **Red**: Distance > 1000km
  * **Security Mode**:
    * ðŸŸ¢ **Green**: Distance < 15km (At Station)
    * ðŸ”´ **Red**: Distance > 15km (Theft risk / Unknown movement)

### 3. Station Matching

* **Exact Match**: Checks if `Return Station` matches a name in `Stations_Merged.csv`.
* **Fuzzy/Slug Match**: Removes special characters and case (e.g., `MÃ¼nchen-Ost` matches `munchenost`).
* **Display**: In the report, if the matched name differs from the input name, it is shown in brackets: `Munich (MÃ¼nchen Hbf)`. If they are identical, only `Munich` is shown.

### 4. Mileage Parsing (Smart Parser)

Handles messy CSV formats for mileage:

* **German Format**: `11.957` -> interpreted as `11,957 km` (Thousands separator).
* **US Format**: `83889.0` -> interpreted as `83,889 km` (Decimal point).
* The logic attempts to guess the format based on the value size and common patterns.

### 5. Night Filter (Security Mode)

* In **Security Mode**, vehicles are only flagged as "Critical" (Red) if the GPS timestamp is during the night (**20:00 - 07:00**).
* Daytime movements are marked as `unknown` / `â˜€ï¸` (Sun icon) to avoid false alarms during business hours.

---

## ðŸ“± Application Modes

### ðŸš— Return Check (Customer)

* **Goal**: Check if returning vehicles are near their return station.
* **Input**: `Bookings_Return_Today.csv`.
* **Logic**: Green = Near, Red = Far.

### ðŸ‘® Security Check (Night)

* **Goal**: Check if unrented cars are moving away from their station.
* **Input**: `Cars without Booking...csv`.
* **Logic**: Green = At Station, Red = Moved away (>15km).
* **Auto-Switch**: The script automatically loads the correct file if you run it.

### ðŸš€ Unified Check (Locked)

* *Disabled / Preview Feature*
* Intended for a future workflow where a single export file contains both Booking and GPS data, removing the need for a separate TCU list.
* Currently locked in the UI.

---

## ðŸ“‚ File Structure

* `ReturnReportTest.html`: Main application (Logic + UI).
* `Stations_Merged.csv`: Master list of stations (Lat/Lon).
* `UpdateDataAndRun.ps1`: Automation script.
* `README.md`: This documentation.

---

Generated by Antigravity
